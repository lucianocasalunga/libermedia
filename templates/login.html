{% extends "base.html" %}
{% block title %}Login{% endblock %}
{% block content %}

<div class="min-h-screen flex items-center justify-center px-4">
  <div class="bg-white/95 dark:bg-gray-800/95 rounded-2xl shadow-2xl p-8 w-full max-w-md border border-gray-200 dark:border-gray-700">
    
    <div class="text-center mb-8">
      <img src="/static/img/logo.jpg" class="w-24 h-24 mx-auto rounded-full border-4 border-yellow-500 mb-4">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">LiberMedia</h1>
      <p class="text-gray-600 dark:text-gray-400">Fa√ßa login com Nostr</p>
    </div>

    <div class="space-y-4">
      
      <!-- Bot√£o NIP-07 (extens√£o) -->
      <button onclick="loginNIP07()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
        üîê Login com Extens√£o (NIP-07)
      </button>

      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white dark:bg-gray-800 text-gray-500">ou</span>
        </div>
      </div>

      <!-- Login manual (nsec) -->
      <form onsubmit="loginManual(event)" class="space-y-4">
        <input 
          type="text" 
          id="nsec" 
          placeholder="Sua nsec (chave privada)" 
          class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
          required
        >
        <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-4 px-6 rounded-xl transition-all">
          üîë Login com nsec
        </button>
      </form>

    </div>

    <p class="text-center text-xs text-gray-500 dark:text-gray-400 mt-6">
      N√£o tem Nostr? <a href="https://nostr.com" target="_blank" class="text-purple-600 hover:underline">Crie uma conta</a>
    </p>

  </div>
</div>
<script>

async function loginManual(e) {
  e.preventDefault();
  console.log('=== LOGIN MANUAL DEBUG ===');
  console.log('Function called');

  const nsecInput = document.getElementById("nsec").value.trim();
  console.log('nsec input value:', nsecInput);
  console.log('nsec length:', nsecInput.length);
  console.log('nsec first 10 chars:', nsecInput.substring(0, 10));
  console.log('nsec last 10 chars:', nsecInput.substring(nsecInput.length - 10));

  if (!nsecInput.startsWith("nsec1")) {
    console.error('Validation failed: nsec does not start with "nsec1"');
    alert("‚ùå nsec inv√°lida! Deve come√ßar com nsec1");
    return;
  }

  try {
    console.log('Attempting to decode nsec...');
    const { nip19, getPublicKey } = window.NostrTools;
    const { type, data: privkey } = nip19.decode(nsecInput);
    console.log('Decoded type:', type);
    console.log('Decoded privkey:', privkey);

    if (type !== "nsec") throw new Error("Tipo inv√°lido");

    const pubkey = getPublicKey(privkey);
    console.log('Generated pubkey:', pubkey);

    const npub = nip19.npubEncode(pubkey);
    console.log('Encoded npub:', npub);

    localStorage.setItem("libermedia_npub", npub);
    localStorage.setItem("libermedia_nsec", nsecInput);
    console.log('Saved to localStorage successfully');
    console.log('=========================');

    location.href = "/dashboard";
  } catch (error) {
    console.error('=== LOGIN ERROR ===');
    console.error('Error message:', error.message);
    console.error('Error stack:', error.stack);
    console.error('Full error:', error);
    console.error('===================');
    alert("‚ùå Erro: " + error.message);
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/nostr-tools@2.3.0/lib/nostr.bundle.js"></script>

<script>
// Converte hex para npub
function hexToNpub(hex) {
  const data = new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
  const words = bech32ToWords(data);
  return bech32Encode('npub', words);
}

function bech32ToWords(data) {
  const result = [];
  let value = 0;
  let bits = 0;
  
  for (let i = 0; i < data.length; i++) {
    value = (value << 8) | data[i];
    bits += 8;
    
    while (bits >= 5) {
      bits -= 5;
      result.push((value >> bits) & 31);
    }
  }
  
  if (bits > 0) {
    result.push((value << (5 - bits)) & 31);
  }
  
  return result;
}

function bech32Encode(prefix, words) {
  const charset = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
  let result = prefix + '1';
  
  for (let i = 0; i < words.length; i++) {
    result += charset[words[i]];
  }
  
  return result;
}

// LOGIN NIP-07 (extens√£o)
async function loginNIP07() {
  try {
    if (!window.nostr) {
      alert('‚ùå Extens√£o Nostr n√£o detectada!\\n\\nInstale: nos2x, Alby ou outra extens√£o NIP-07');
      return;
    }
    
    const pubkey = await window.nostr.getPublicKey();
    const npub = hexToNpub(pubkey);
    
    // Salva no localStorage
    localStorage.setItem('libermedia_npub', npub);
    localStorage.setItem('libermedia_pubkey', pubkey);
    
    // Redireciona
    window.location.href = '/dashboard';
    
  } catch (error) {
    console.error(error);
    alert('‚ùå Erro ao conectar com extens√£o: ' + error.message);
  }
}
</script>

{% endblock %}
