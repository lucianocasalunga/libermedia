{% extends "base.html" %}
{% block title %}Cadastro{% endblock %}
{% block content %}

<div class="min-h-[70vh] flex items-center justify-center">
  <div class="bg-white/95 dark:bg-gray-900/95 rounded-2xl shadow-2xl p-10 w-full max-w-md">
    
    <h1 class="text-3xl font-bold mb-6 text-center">Criar Identidade</h1>

    <div id="a1">
      <button onclick="gerar()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg">
        üîë Gerar Chaves
      </button>
    </div>

    <div id="a2" class="hidden space-y-4">
      <div class="bg-green-100 dark:bg-green-900/30 p-4 rounded">
        <p class="font-bold mb-2">npub (hex simplificado):</p>
        <code id="n" class="block text-xs bg-gray-800 text-green-400 p-2 rounded break-all"></code>
        <button onclick="cp('n')" class="mt-2 text-sm underline">Copiar</button>
      </div>

      <div class="bg-red-100 dark:bg-red-900/30 p-4 rounded">
        <p class="font-bold mb-2">nsec (hex simplificado):</p>
        <code id="s" class="block text-xs bg-gray-800 text-red-400 p-2 rounded break-all"></code>
        <button onclick="cp('s')" class="mt-2 text-sm underline">Copiar</button>
        <p class="text-xs text-red-600 mt-2">‚ö†Ô∏è NUNCA compartilhe!</p>
      </div>

      <button onclick="salvar()" id="btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">
        ‚úÖ Continuar
      </button>
    </div>

    <div class="mt-6 text-center">
      <a href="/" class="text-sm hover:text-yellow-500">‚Üê Voltar</a>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/nostr-tools@2.3.0/lib/nostr.bundle.js"></script>

<script>
let k={};

function gerar(){
  const { nip19, getPublicKey, generateSecretKey } = window.NostrTools;

  // Gera chave privada adequada (32 bytes)
  const privkey = generateSecretKey();

  // Deriva a chave p√∫blica da privada
  const pubkey = getPublicKey(privkey);

  // Encoding bech32 correto
  k.nsec = nip19.nsecEncode(privkey);
  k.npub = nip19.npubEncode(pubkey);

  document.getElementById('n').innerText = k.npub;
  document.getElementById('s').innerText = k.nsec;
  document.getElementById('a1').classList.add('hidden');
  document.getElementById('a2').classList.remove('hidden');
}

function cp(id){
  const text = document.getElementById(id).innerText;
  console.log('=== DEBUG COPIAR ===');
  console.log('Element ID:', id);
  console.log('Text being copied:', text);
  console.log('Text length:', text.length);
  console.log('===================');
  navigator.clipboard.writeText(text);
  alert('Copiado!');
}

async function salvar(){
  if(!confirm('Salvou as chaves?')) return;
  const btn=document.getElementById('btn');
  btn.disabled=true;
  btn.innerText='Salvando...';
  
  try {
    localStorage.setItem('libermedia_npub', k.npub);
    localStorage.setItem('libermedia_nsec', k.nsec);
    
    const r=await fetch('/api/auth/register',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({npub:k.npub,nsec:k.nsec,nome:'Usu√°rio'})
    });
    
    const d=await r.json();
    
    if(d.status==='ok'){
      alert('‚úÖ Conta criada!');
      location.href='/dashboard';
    }else{
      alert('Erro: '+d.error);
      btn.disabled=false;
      btn.innerText='‚úÖ Continuar';
    }
  }catch(e){
    alert('Erro: '+e);
    btn.disabled=false;
    btn.innerText='‚úÖ Continuar';
  }
}
</script>

{% endblock %}
