{% extends "base.html" %}
{% block title %}Dashboard - LiberMedia{% endblock %}
{% block content %}
<style>
.view-lista .files-container { display: flex; flex-direction: column; gap: 0.5rem; }
.view-lista .file-card { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; }
.view-lista .file-card img { width: 60px; height: 60px; object-fit: cover; }
.view-lista .file-info { flex: 1; }
.view-lista .file-actions { display: flex; gap: 0.5rem; }
.view-grade .files-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
.view-grade .file-card { display: block; }
</style>
<style>
.view-lista .files-container { display: flex; flex-direction: column; gap: 0.5rem; }
.view-lista .file-card { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; }
.view-lista .file-card img { width: 60px; height: 60px; object-fit: cover; }
.view-lista .file-info { flex: 1; }
.view-lista .file-actions { display: flex; gap: 0.5rem; }
.view-grade .files-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
.view-grade .file-card { display: block; }
</style>

<div class="container mx-auto">
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    
    <!-- SIDEBAR -->
    <div class="bg-white/95 dark:bg-gray-800/95 rounded-xl shadow-xl p-6 border border-gray-200 dark:border-gray-700 space-y-4">
      <div class="text-center">
        <img src="/static/img/avatar.png" class="w-20 h-20 mx-auto rounded-full border-4 border-yellow-500 mb-2">
        <p class="font-bold text-gray-900 dark:text-white">UsuÃ¡rio</p>
        <p id="npubShort" class="text-xs text-gray-600 dark:text-gray-400 break-all"></p>
      </div>
      
      <div class="flex gap-2">
        <button onclick="location.href='/configuracoes'" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded">âš™ï¸</button>
        <button onclick="logout()" class="flex-1 bg-red-600 hover:bg-red-500 text-white p-2 rounded">ğŸšª</button>
      </div>
      
      <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg">
        <p class="text-sm text-gray-900 dark:text-white">ğŸ“¦ <strong id="total">0</strong> arquivos</p>
      </div>
      
      <hr class="border-gray-300 dark:border-gray-600">
      
      <div>
        <p class="font-bold text-gray-700 dark:text-gray-300 mb-2 text-sm">ğŸ“ Pastas</p>
        <div class="space-y-1">
          <button onclick="filtrarPasta('Mesa')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ“‚ Mesa</button>
          <button onclick="filtrarPasta('Photos')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ“· Photos</button>
          <button onclick="filtrarPasta('Videos')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ¥ Videos</button>
          <button onclick="filtrarPasta('Docs')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ“„ Docs</button>
          <button onclick="filtrarPasta('Audio')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸµ Audio</button>
          <button onclick="criarPasta()" class="w-full text-left p-2 text-sm bg-yellow-500 hover:bg-yellow-600 text-white rounded font-bold mt-2">â• Criar Pasta</button>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="lg:col-span-3 bg-white/95 dark:bg-gray-800/95 rounded-xl shadow-xl p-8 border border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Seus Arquivos ğŸ“</h1>
        <div class="flex gap-2 bg-gray-200 dark:bg-gray-700 p-1 rounded-lg">
          <button id="btnGrade" onclick="toggleView('grade')" class="px-4 py-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-white font-semibold">âŠ Grade</button>
          <button id="btnLista" onclick="toggleView('lista')" class="px-4 py-2 rounded text-gray-600 dark:text-gray-300">â˜° Lista</button>
        </div>
      </div>
      
      <!-- Upload Area -->
      <div id="dropArea" class="border-4 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-12 text-center cursor-pointer hover:border-yellow-500 mb-8 bg-gray-50 dark:bg-gray-900/30">
        <input type="file" id="fileInput" multiple hidden>
        <p class="text-5xl mb-3">ğŸ“¤</p>
        <p class="text-xl font-bold text-gray-900 dark:text-white mb-2">Arraste arquivos aqui</p>
        <p class="text-sm text-gray-600 dark:text-gray-400">ou clique</p>
      </div>

      <!-- Progress -->
      <div id="progress" class="hidden mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <div class="flex justify-between mb-2">
          <span class="text-sm font-medium text-gray-900 dark:text-white">Enviando...</span>
          <span id="progressText" class="text-sm text-gray-500">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="progressBar" class="bg-yellow-500 h-2 rounded-full transition-all" style="width: 0%"></div>
        </div>
      </div>

      <!-- Files Grid -->
      <div id="filesWrapper" class="view-grade">
        <div id="files" class="files-container"></div>
      </div>
      
      <!-- Empty State -->
      <div id="empty" class="hidden text-center py-12">
        <p class="text-gray-500 dark:text-gray-400">Nenhum arquivo ainda. FaÃ§a upload!</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onclick="closeModal()">
  <div class="max-w-6xl w-full relative" onclick="event.stopPropagation()">
    <button onclick="closeModal()" class="absolute top-4 right-4 text-white text-3xl hover:text-yellow-400 z-10">&times;</button>
    
    <!-- NavegaÃ§Ã£o -->
    <button onclick="prevImage()" class="absolute left-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-3 rounded-full text-2xl">â€¹</button>
    <button onclick="nextImage()" class="absolute right-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-3 rounded-full text-2xl">â€º</button>
    
    <img id="modalImg" src="" class="w-full h-auto max-h-[80vh] object-contain rounded-lg shadow-2xl">
    
    <div class="mt-4 bg-white/10 backdrop-blur-sm rounded-lg p-4 text-white">
      <p id="modalNome" class="font-semibold text-lg"></p>
      <p id="modalInfo" class="text-sm text-gray-300 mt-1"></p>
    </div>
  </div>
</div>
</div>

<script>
const npub = localStorage.getItem('libermedia_npub');
if (!npub) { alert('FaÃ§a login!'); location.href = '/'; }

document.getElementById('npubShort').textContent = npub.slice(0, 20) + '...';

let todosArquivos = [];
let pastaAtual = 'Mesa';
let viewMode = 'grade';
let viewMode = 'grade';

// Upload
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');

dropArea.onclick = () => fileInput.click();
dropArea.ondragover = (e) => { e.preventDefault(); dropArea.classList.add('border-yellow-500'); };
dropArea.ondragleave = () => dropArea.classList.remove('border-yellow-500');
dropArea.ondrop = (e) => { 
  e.preventDefault(); 
  dropArea.classList.remove('border-yellow-500');
  upload(Array.from(e.dataTransfer.files)); 
};
fileInput.onchange = (e) => upload(Array.from(e.target.files));

async function upload(files) {
  const progress = document.getElementById('progress');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  
  progress.classList.remove('hidden');
  
  for (let i = 0; i < files.length; i++) {
    const fd = new FormData();
    fd.append('file', files[i]);
    fd.append('npub', npub);
    fd.append('pasta', 'Geral');
    
    const xhr = new XMLHttpRequest();
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = pct + '%';
        progressText.textContent = `${i+1}/${files.length} - ${pct}%`;
      }
    };
    
    await new Promise((resolve) => {
      xhr.onload = () => resolve();
      xhr.open('POST', '/api/upload');
      xhr.send(fd);
    });
  }
  
  progress.classList.add('hidden');
  loadFiles();
}

// Load files
async function loadFiles() {
  const res = await fetch(`/api/arquivos?npub=${npub}`);
  const data = await res.json();
  
  todosArquivos = data.arquivos || [];
  document.getElementById('total').textContent = todosArquivos.length;
  
  renderFiles();
}

function toggleView(mode) {
  viewMode = mode;
  const wrapper = document.getElementById('filesWrapper');
  const btnGrade = document.getElementById('btnGrade');
  const btnLista = document.getElementById('btnLista');
  
  if (mode === 'grade') {
    wrapper.className = 'view-grade';
    btnGrade.className = 'px-4 py-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-white font-semibold';
    btnLista.className = 'px-4 py-2 rounded text-gray-600 dark:text-gray-300';
  } else {
    wrapper.className = 'view-lista';
    btnLista.className = 'px-4 py-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-white font-semibold';
    btnGrade.className = 'px-4 py-2 rounded text-gray-600 dark:text-gray-300';
  }
  
  renderFiles();
}

function toggleView(mode) {
  viewMode = mode;
  const wrapper = document.getElementById('filesWrapper');
  const btnGrade = document.getElementById('btnGrade');
  const btnLista = document.getElementById('btnLista');
  
  if (mode === 'grade') {
    wrapper.className = 'view-grade';
    btnGrade.className = 'px-4 py-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-white font-semibold';
    btnLista.className = 'px-4 py-2 rounded text-gray-600 dark:text-gray-300';
  } else {
    wrapper.className = 'view-lista';
    btnLista.className = 'px-4 py-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-white font-semibold';
    btnGrade.className = 'px-4 py-2 rounded text-gray-600 dark:text-gray-300';
  }
  
  renderFiles();
}

function renderFiles() {
  const filesDiv = document.getElementById("files");
  const emptyDiv = document.getElementById("empty");
  
  let arquivosFiltrados = todosArquivos;
  if (pastaAtual !== "Mesa") {
    arquivosFiltrados = todosArquivos.filter(f => f.pasta === pastaAtual);
  }
  
  if (arquivosFiltrados.length === 0) {
    filesDiv.innerHTML = "";
    emptyDiv.classList.remove("hidden");
    return;
  }
  
  emptyDiv.classList.add("hidden");
  
  if (viewMode === "grade") {
    filesDiv.innerHTML = arquivosFiltrados.map(f => `
      <div class="file-card bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-lg transition overflow-hidden border border-gray-200 dark:border-gray-700">
        <img src="https://libermedia.app/f/${f.id}" 
             class="w-full h-40 object-cover cursor-pointer" 
             onclick="openModal(${f.id})"
             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27%3E%3Cpath stroke=%27%239ca3af%27 stroke-width=%272%27 d=%27M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z%27/%3E%3C/svg%3E'">
        <div class="p-3">
          <h3 class="text-xs text-gray-600 dark:text-gray-400 truncate" title="${f.nome_original}">${f.nome_original}</h3>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">${formatSize(f.tamanho)}</p>
          <button onclick="copyLink('https://libermedia.app/f/${f.id}')" class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-white text-sm py-2 rounded">
            Copiar
          </button>
        </div>
      </div>
    `).join("");
  } else {
    filesDiv.innerHTML = arquivosFiltrados.map(f => `
      <div class="file-card bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-lg transition border border-gray-200 dark:border-gray-700">
        <img src="https://libermedia.app/f/${f.id}" 
             class="rounded cursor-pointer" 
             onclick="openModal(${f.id})"
             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27%3E%3Cpath stroke=%27%239ca3af%27 stroke-width=%272%27 d=%27M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z%27/%3E%3C/svg%3E'">
        <div class="file-info">
          <h3 class="text-sm font-medium text-gray-900 dark:text-white truncate">${f.nome_original}</h3>
          <p class="text-xs text-gray-500">${formatSize(f.tamanho)}</p>
        </div>
        <div class="file-actions">
          <button onclick="copyLink('https://libermedia.app/f/${f.id}')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" title="Copiar link">
            ğŸ“‹
          </button>
          <button onclick="showDetails(${f.id})" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" title="Mais opÃ§Ãµes">
            â‹®
          </button>
        </div>
      </div>
    `).join("");
  }
}

function filtrarPasta(pasta) {
  pastaAtual = pasta;
  renderFiles();
}

function formatSize(bytes) {
  if (!bytes) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function copyLink(link) {
  navigator.clipboard.writeText(link);
  alert('Link copiado!');
}

let currentModalIndex = 0;
let modalArquivos = [];

function openModal(fileId) {
  modalArquivos = todosArquivos.filter(f => {
    if (pastaAtual === "Mesa") return true;
    return f.pasta === pastaAtual;
  });
  currentModalIndex = modalArquivos.findIndex(f => f.id === fileId);
  showModalImage();
  document.getElementById('modalImg').src = url;
  document.getElementById('modal').classList.remove('hidden');
}

function showModalImage() {
  if (currentModalIndex < 0 || currentModalIndex >= modalArquivos.length) return;
  
  const arquivo = modalArquivos[currentModalIndex];
  document.getElementById("modalImg").src = `https://libermedia.app/f/${arquivo.id}`;
  document.getElementById("modalNome").textContent = arquivo.nome_original;
  document.getElementById("modalInfo").textContent = `${formatSize(arquivo.tamanho)} â€¢ ${currentModalIndex + 1}/${modalArquivos.length}`;
  document.getElementById("modal").classList.remove("hidden");
}

function prevImage() {
  if (currentModalIndex > 0) {
    currentModalIndex--;
    showModalImage();
  }
}

function nextImage() {
  if (currentModalIndex < modalArquivos.length - 1) {
    currentModalIndex++;
    showModalImage();
  }
}

function showDetails(fileId) {
  const arquivo = todosArquivos.find(f => f.id === fileId);
  if (!arquivo) return;
  
  const detalhes = `
ğŸ“„ Nome: ${arquivo.nome_original}
ğŸ“¦ Tamanho: ${formatSize(arquivo.tamanho)}
ğŸ“ Pasta: ${arquivo.pasta}
ğŸ”— Link: https://libermedia.app/f/${arquivo.id}
  `;
  
  alert(detalhes);
  copyLink(`https://libermedia.app/f/${arquivo.id}`);
}

function closeModal() {
  document.getElementById('modal').classList.add('hidden');
}

function criarPasta() {
  const nome = prompt("Nome da nova pasta:");
  if (!nome || nome.trim() === "") return;
  
  const pastaBtn = document.createElement("button");
  pastaBtn.onclick = () => filtrarPasta(nome);
  pastaBtn.className = "w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white";
  pastaBtn.innerHTML = `ğŸ“ ${nome}`;
  
  const container = document.querySelector(".space-y-1");
  const criarBtn = container.querySelector("button[onclick*=criarPasta]");
  container.insertBefore(pastaBtn, criarBtn);
  
  alert(`Pasta "${nome}" criada! Use-a no prÃ³ximo upload.`);
}

function logout() {
  localStorage.removeItem('libermedia_npub');
  location.href = '/';
}

// Load on start
loadFiles();
</script>

{% endblock %}
