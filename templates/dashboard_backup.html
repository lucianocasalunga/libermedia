{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<div class="container mx-auto px-4 py-6">
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    
    <div class="bg-white/95 dark:bg-gray-800/95 rounded-xl shadow-xl p-6 border border-gray-200 dark:border-gray-700 space-y-4">
      <div class="text-center">
        <img src="/static/img/avatar.png" class="w-20 h-20 mx-auto rounded-full border-4 border-yellow-500 mb-2">
        <p class="font-bold text-gray-900 dark:text-white">UsuÃ¡rio</p>
        <p id="npubShort" class="text-xs text-gray-600 dark:text-gray-400 break-all"></p>
      </div>
      
      <div class="flex gap-2">
        <button onclick="location.href='/configuracoes'" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded">âš™ï¸</button>
        <button onclick="sair()" class="flex-1 bg-red-600 hover:bg-red-500 text-white p-2 rounded">ğŸšª</button>
      </div>
      
      <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg">
        <p class="text-sm text-gray-900 dark:text-white">ğŸ“¦ <strong id="total">0</strong> arquivos</p>
      </div>
      
      <hr class="border-gray-300 dark:border-gray-600">
      
      <div>
        <p class="font-bold text-gray-700 dark:text-gray-300 mb-2 text-sm">ğŸ“ Pastas</p>
        <div class="space-y-1">
          <button onclick="filtrar('Todas')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ“‚ Todas</button>
          <button onclick="filtrar('Photos')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ“· Photos</button>
          <button onclick="filtrar('Videos')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ¥ Videos</button>
          <button onclick="filtrar('Docs')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ“„ Docs</button>
          <button onclick="filtrar('Audio')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸµ Audio</button>
        </div>
      </div>
    </div>

    <div class="lg:col-span-3 bg-white/95 dark:bg-gray-800/95 rounded-xl shadow-xl p-8 border border-gray-200 dark:border-gray-700">
      <h1 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Seus Arquivos ğŸ“</h1>
      <div class="flex justify-between items-center mb-6">
        <div></div>
        <div class="flex gap-2">
          <button id="btnLista" onclick="toggleView("lista")" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold shadow-lg">ğŸ“œ Lista</button>
          <button id="btnGrade" onclick="toggleView("grade")" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold shadow-lg">ğŸ¨ Grade</button>
        </div>
      </div>
      
      <div id="drop" class="border-4 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-12 text-center cursor-pointer hover:border-yellow-500 mb-8 bg-gray-50 dark:bg-gray-900/30">
        <input type="file" id="input" multiple class="hidden">
        <p class="text-5xl mb-3">ğŸ“¤</p>
        <p class="text-xl font-bold text-gray-900 dark:text-white mb-2">Arraste arquivos aqui</p>
        <p class="text-sm text-gray-600 dark:text-gray-400">ou clique</p>
      </div>

      <div id="lista" class="space-y-3"></div>
    </div>
  </div>
</div>

<div id="modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onclick="fechar()">
  <div class="relative max-w-6xl" onclick="event.stopPropagation()">
    <button onclick="fechar()" class="absolute -top-12 right-0 text-white text-4xl hover:text-red-500">&times;</button>
function toggleView(tipo){
  visualizacao=tipo;
  localStorage.setItem("libermedia_view",tipo);
  document.getElementById("btnLista").className=tipo==="lista"?"px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold":"px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold";
  document.getElementById("btnGrade").className=tipo==="grade"?"px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold":"px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold";
  carregar();
}
    <img id="img" src="" class="max-w-full max-h-screen rounded-lg shadow-2xl">
    <p id="nome" class="text-white text-center mt-4 text-lg"></p>
  </div>
</div>

<script>
let visualizacao = localStorage.getItem("libermedia_view") || "lista";
const npub=localStorage.getItem('libermedia_npub');
if(!npub){alert('FaÃ§a login!');location.href='/';}
document.getElementById('npubShort').innerText=npub.slice(0,20)+'...';

const drop=document.getElementById('drop');
const input=document.getElementById('input');
let pasta='Todas';

drop.onclick=()=>input.click();
drop.ondragover=e=>{e.preventDefault();drop.classList.add('border-yellow-500');};
drop.ondragleave=()=>drop.classList.remove('border-yellow-500');
drop.ondrop=e=>{e.preventDefault();drop.classList.remove('border-yellow-500');enviar(e.dataTransfer.files);};
input.onchange=()=>enviar(input.files);

async function enviar(files){
  for(let f of files){
    const fd=new FormData();
    fd.append('file',f);
    fd.append('npub',npub);
    fd.append('pasta',pasta==='Todas'?'Geral':pasta);
    try{
      const r=await fetch('/api/upload',{method:'POST',body:fd});
      if((await r.json()).status!=='ok')alert('Erro: '+f.name);
    }catch{alert('Erro');}
  }
  carregar();
}

async function carregar(){
  try{
    let html="";
    if(visualizacao==="lista"){
      for(let a of d.arquivos){
        const icone={"image":"ğŸ–¼ï¸","video":"ğŸ¥","audio":"ğŸµ"}[a.tipo]||"ğŸ“„";
        const mb=(a.tamanho/1024/1024).toFixed(2);
        html+="<div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg flex justify-between items-center border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800">";
        html+="<div class="flex items-center gap-3">";
        if(a.tipo==="image"){
          html+="<img src=""+a.url+"" class="w-16 h-16 object-cover rounded border-2 cursor-pointer hover:scale-105" onclick="ver('"+a.url+"','"+a.nome+"')">";
        }else{
          html+="<span class="text-4xl">"+icone+"</span>";
        }
        html+="<div><p class="font-bold text-gray-900 dark:text-white">"+a.nome+"</p><p class="text-xs text-gray-600 dark:text-gray-400">"+mb+" MB â€¢ "+a.pasta+"</p></div></div>";
        html+="<div class="flex gap-2">";
        html+="<button onclick="copiar("+a.id+",'"+a.url+"')" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 p-2 rounded" title="Copiar link">ğŸ”—</button>";
        html+="<a href=""+a.url+"" download class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 p-2 rounded" title="Download">â¬‡ï¸</a>";
        html+="</div></div>";
      }
    }else{
      html="<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">";
      for(let a of d.arquivos){
        const icone={"image":"ğŸ–¼ï¸","video":"ğŸ¥","audio":"ğŸµ"}[a.tipo]||"ğŸ“„";
        const mb=(a.tamanho/1024/1024).toFixed(2);
        html+="<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border-2 hover:shadow-2xl hover:scale-105 transition-all overflow-hidden">";
        if(a.tipo==="image"){
          html+="<img src=""+a.url+"" class="w-full h-56 object-cover cursor-pointer" onclick="ver('"+a.url+"','"+a.nome+"')">";
        }else{
          html+="<div class="w-full h-56 flex items-center justify-center bg-gray-100 dark:bg-gray-900"><span class="text-7xl">"+icone+"</span></div>";
        }
        html+="<div class="p-4">";
        html+="<p class="font-bold text-gray-900 dark:text-white truncate mb-1" title=""+a.nome+"">"+a.nome+"</p>";
        html+="<p class="text-xs text-gray-600 dark:text-gray-400 mb-3">"+mb+" MB â€¢ "+a.pasta+"</p>";
        html+="<div class="flex gap-2">";
        html+="<button onclick="copiar("+a.id+",'"+a.url+"')" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-semibold">ğŸ”—</button>";
        html+="<a href=""+a.url+"" download class="flex-1 bg-gray-700 hover:bg-gray-800 text-white py-2 rounded-lg font-semibold text-center">â¬‡ï¸</a>";
        html+="</div></div></div>";
      }
      html+="</div>";
    }
    lista.innerHTML=html;
      if(a.tipo==='image'){
        html+='<img src="'+a.url+'" class="w-16 h-16 object-cover rounded border-2 cursor-pointer hover:scale-105" onclick="ver(\''+a.url+'\',\''+a.nome+'\')">';
      }else{
        html+='<span class="text-4xl">'+icone+'</span>';
      }
      
      html+='<div><p class="font-bold text-gray-900 dark:text-white">'+a.nome+'</p><p class="text-xs text-gray-600 dark:text-gray-400">'+mb+' MB â€¢ '+a.pasta+'</p></div></div>';
      html+='<div class="flex gap-2">';
      html+='<button onclick="copiar('+a.id+',\''+a.url+'\')" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 p-2 rounded" title="Copiar link">ğŸ”—</button>';
      html+='<a href="'+a.url+'" download class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 p-2 rounded" title="Download">â¬‡ï¸</a>';
      html+='</div></div>';
    }
    lista.innerHTML=html;
  }catch(e){console.error(e);}
}

async function copiar(id,url){
  try{
    const ext=url.split(".").pop();
    const link=window.location.origin+"/f/"+id+"."+ext;
    await navigator.clipboard.writeText(link);
    mostrarToast("ğŸ”— Link copiado: /f/"+id+"."+ext);
  }catch{mostrarToast("âŒ Erro");}
}

function mostrarToast(msg){
  const t=document.createElement('div');
  t.className='fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-2xl z-50';
  t.innerText=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2000);
}

function filtrar(p){pasta=p;carregar();}
function ver(url,n){document.getElementById('img').src=url;document.getElementById('nome').innerText=n;document.getElementById('modal').classList.remove('hidden');}
function fechar(){document.getElementById('modal').classList.add('hidden');}
function sair(){if(confirm('Sair?')){localStorage.clear();location.href='/';}}
document.addEventListener('keydown',e=>{if(e.key==='Escape')fechar();});
carregar();
</script>

{% endblock %}
