{% extends "base.html" %}
{% block title %}Dashboard - LiberMedia{% endblock %}
{% block content %}

<div class="container mx-auto">
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    
    <!-- SIDEBAR -->
    <div class="bg-white/95 dark:bg-gray-800/95 rounded-xl shadow-xl p-6 border border-gray-200 dark:border-gray-700 space-y-4">
      <div class="text-center">
        <img src="/static/img/avatar.png" class="w-20 h-20 mx-auto rounded-full border-4 border-yellow-500 mb-2">
        <p class="font-bold text-gray-900 dark:text-white">UsuÃ¡rio</p>
        <p id="npubShort" class="text-xs text-gray-600 dark:text-gray-400 break-all"></p>
      </div>
      
      <div class="flex gap-2">
        <button onclick="location.href='/configuracoes'" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded">âš™ï¸</button>
        <button onclick="logout()" class="flex-1 bg-red-600 hover:bg-red-500 text-white p-2 rounded">ğŸšª</button>
      </div>
      
      <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg">
        <p class="text-sm text-gray-900 dark:text-white">ğŸ“¦ <strong id="total">0</strong> arquivos</p>
      </div>
      
      <hr class="border-gray-300 dark:border-gray-600">
      
      <div>
        <p class="font-bold text-gray-700 dark:text-gray-300 mb-2 text-sm">ğŸ“ Pastas</p>
        <div class="space-y-1">
          <button onclick="filtrarPasta('Todas')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ“‚ Todas</button>
          <button onclick="filtrarPasta('Photos')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ“· Photos</button>
          <button onclick="filtrarPasta('Videos')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ¥ Videos</button>
          <button onclick="filtrarPasta('Docs')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸ“„ Docs</button>
          <button onclick="filtrarPasta('Audio')" class="w-full text-left p-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-gray-900 dark:text-white">ğŸµ Audio</button>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="lg:col-span-3 bg-white/95 dark:bg-gray-800/95 rounded-xl shadow-xl p-8 border border-gray-200 dark:border-gray-700">
      <h1 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Seus Arquivos ğŸ“</h1>
      
      <!-- Upload Area -->
      <div id="dropArea" class="border-4 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-12 text-center cursor-pointer hover:border-yellow-500 mb-8 bg-gray-50 dark:bg-gray-900/30">
        <input type="file" id="fileInput" multiple hidden>
        <p class="text-5xl mb-3">ğŸ“¤</p>
        <p class="text-xl font-bold text-gray-900 dark:text-white mb-2">Arraste arquivos aqui</p>
        <p class="text-sm text-gray-600 dark:text-gray-400">ou clique</p>
      </div>

      <!-- Progress -->
      <div id="progress" class="hidden mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <div class="flex justify-between mb-2">
          <span class="text-sm font-medium text-gray-900 dark:text-white">Enviando...</span>
          <span id="progressText" class="text-sm text-gray-500">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="progressBar" class="bg-yellow-500 h-2 rounded-full transition-all" style="width: 0%"></div>
        </div>
      </div>

      <!-- Files Grid -->
      <div id="files" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
      
      <!-- Empty State -->
      <div id="empty" class="hidden text-center py-12">
        <p class="text-gray-500 dark:text-gray-400">Nenhum arquivo ainda. FaÃ§a upload!</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onclick="closeModal()">
  <div class="max-w-4xl w-full" onclick="event.stopPropagation()">
    <button onclick="closeModal()" class="absolute top-4 right-4 text-white text-3xl hover:text-yellow-400">&times;</button>
    <img id="modalImg" src="" class="w-full h-auto rounded-lg shadow-2xl">
  </div>
</div>

<script>
const npub = localStorage.getItem('libermedia_npub');
if (!npub) { alert('FaÃ§a login!'); location.href = '/'; }

document.getElementById('npubShort').textContent = npub.slice(0, 20) + '...';

let todosArquivos = [];
let pastaAtual = 'Todas';

// Upload
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');

dropArea.onclick = () => fileInput.click();
dropArea.ondragover = (e) => { e.preventDefault(); dropArea.classList.add('border-yellow-500'); };
dropArea.ondragleave = () => dropArea.classList.remove('border-yellow-500');
dropArea.ondrop = (e) => { 
  e.preventDefault(); 
  dropArea.classList.remove('border-yellow-500');
  upload(Array.from(e.dataTransfer.files)); 
};
fileInput.onchange = (e) => upload(Array.from(e.target.files));

async function upload(files) {
  const progress = document.getElementById('progress');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  
  progress.classList.remove('hidden');
  
  for (let i = 0; i < files.length; i++) {
    const fd = new FormData();
    fd.append('file', files[i]);
    fd.append('npub', npub);
    fd.append('pasta', 'Geral');
    
    const xhr = new XMLHttpRequest();
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = pct + '%';
        progressText.textContent = `${i+1}/${files.length} - ${pct}%`;
      }
    };
    
    await new Promise((resolve) => {
      xhr.onload = () => resolve();
      xhr.open('POST', '/api/upload');
      xhr.send(fd);
    });
  }
  
  progress.classList.add('hidden');
  loadFiles();
}

// Load files
async function loadFiles() {
  const res = await fetch(`/api/arquivos?npub=${npub}`);
  const data = await res.json();
  
  todosArquivos = data.arquivos || [];
  document.getElementById('total').textContent = todosArquivos.length;
  
  renderFiles();
}

function renderFiles() {
  const filesDiv = document.getElementById('files');
  const emptyDiv = document.getElementById('empty');
  
  let arquivosFiltrados = todosArquivos;
  if (pastaAtual !== 'Todas') {
    arquivosFiltrados = todosArquivos.filter(f => f.pasta === pastaAtual);
  }
  
  if (arquivosFiltrados.length === 0) {
    filesDiv.innerHTML = '';
    emptyDiv.classList.remove('hidden');
    return;
  }
  
  emptyDiv.classList.add('hidden');
  
  filesDiv.innerHTML = arquivosFiltrados.map(f => `
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-lg transition overflow-hidden border border-gray-200 dark:border-gray-700">
      <img src="https://libermedia.app/f/${f.id}" 
           class="w-full h-40 object-cover cursor-pointer" 
           onclick="openModal('https://libermedia.app/f/${f.id}')"
           onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27%3E%3Cpath stroke=%27%239ca3af%27 stroke-width=%272%27 d=%27M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z%27/%3E%3C/svg%3E'">
      <div class="p-3">
        <h3 class="font-semibold text-sm truncate text-gray-900 dark:text-white" title="${f.nome_original}">${f.nome_original}</h3>
        <p class="text-xs text-gray-500 mt-1">${formatSize(f.tamanho)}</p>
        <button onclick="copyLink('https://libermedia.app/f/${f.id}')" class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-white text-sm py-2 rounded">
          Copiar Link
        </button>
      </div>
    </div>
  `).join('');
}

function filtrarPasta(pasta) {
  pastaAtual = pasta;
  renderFiles();
}

function formatSize(bytes) {
  if (!bytes) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function copyLink(link) {
  navigator.clipboard.writeText(link);
  alert('Link copiado!');
}

function openModal(url) {
  document.getElementById('modalImg').src = url;
  document.getElementById('modal').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('modal').classList.add('hidden');
}

function logout() {
  localStorage.removeItem('libermedia_npub');
  location.href = '/';
}

// Load on start
loadFiles();
</script>

{% endblock %}
